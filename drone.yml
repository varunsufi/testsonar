---
kind: pipeline
name: branch-testsonar 

platform:
  os: linux
  arch: amd64

steps:
- name: dependency-check
  image: maven 
  commands:
  - mvn clean org.owasp:dependency-check-maven:5.2.2:aggregate -DcveValidForHours=24 -DcentralAnalyzerEnabled=false $([ -f suppressions.xml ] && echo "-DfailBuildOnAnyVulnerability=true -DsuppressionFiles=suppressions.xml") --gs settings.xml
  - ls /drone/src/.reports/dependency-check
  environment:
    MAVEN_OPTS: -Xmx2048m
    MAVEN_PASSWORD:
      from_secret: maven_password
    MAVEN_USERNAME:
      from_secret: maven_username

- name: build-maven
  image: maven
  commands:
  - mkdir -p build-artifacts
  - mvn clean install --gs settings.xml
  - cp target/common-services-skeleton-*.jar build-artifacts
  - ls build-artifacts

- name: sonar
  image: maven 
  commands:
  - mvn sonar:sonar
  environment:
    MAVEN_OPTS: -Xmx512m
  depends_on:
  - dependency-check
  - build-maven

trigger:
  event:
  - pull_request
